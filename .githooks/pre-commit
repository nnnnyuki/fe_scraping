#!/bin/sh
set -eu

STAGED="$(git diff --cached --name-only)"

# block .env
echo "$STAGED" | grep -xq ".env" && {
  echo "ERROR: .env is staged. Run: git restore --staged .env" >&2
  exit 1
}

# block generated files
echo "$STAGED" | grep -Eq '^data/mail_archive/(imap|logs)/' && {
  echo "ERROR: generated files under data/mail_archive are staged." >&2
  echo "Run: git restore --staged data/mail_archive/imap/* data/mail_archive/logs/*" >&2
  exit 1
}

# block large files (>10MB)
MAX=10485760
echo "$STAGED" | while IFS= read -r f; do
  [ -f "$f" ] || continue
  size=$(wc -c < "$f" 2>/dev/null || echo 0)
  if [ "$size" -ge "$MAX" ]; then
    echo "ERROR: large file staged: $f ($size bytes)" >&2
    echo "Run: git restore --staged \"$f\"" >&2
    exit 1
  fi
done

exit 0

